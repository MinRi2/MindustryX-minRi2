From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: way-zer <himc.wicp@gmail.com>
Date: Fri, 23 Jun 2023 16:18:22 +0800
Subject: [PATCH] H.API: add SendPacketEvent

---
 core/src/mindustry/net/ArcNetProvider.java | 3 +++
 core/src/mindustry/net/Net.java            | 6 +++++-
 2 files changed, 8 insertions(+), 1 deletion(-)

diff --git a/core/src/mindustry/net/ArcNetProvider.java b/core/src/mindustry/net/ArcNetProvider.java
index 66d2d5278ccc45716c9eb2802d64cc6f2fa22899..cf34367b9c350622a017abf32965682649be8394 100644
--- a/core/src/mindustry/net/ArcNetProvider.java
+++ b/core/src/mindustry/net/ArcNetProvider.java
@@ -16,6 +16,7 @@ import mindustry.game.EventType.*;
 import mindustry.net.Administration.*;
 import mindustry.net.Net.*;
 import mindustry.net.Packets.*;
+import mindustryX.events.*;
 import net.jpountz.lz4.*;
 
 import java.io.*;
@@ -342,6 +343,7 @@ public class ArcNetProvider implements NetProvider{
 
         @Override
         public void sendStream(Streamable stream){
+            if(SendPacketEvent.emit(this, null, stream)) return;
             connection.addListener(new InputStreamSender(stream.stream, 1024){
                 int id;
 
@@ -367,6 +369,7 @@ public class ArcNetProvider implements NetProvider{
 
         @Override
         public void send(Object object, boolean reliable){
+            if(SendPacketEvent.emit(this, null, object)) return;
             try{
                 if(connection.isConnected()){
                     if(reliable){
diff --git a/core/src/mindustry/net/Net.java b/core/src/mindustry/net/Net.java
index a5c319220ef911ce369a0b2b7ea441798f45046d..cc25224fa3d8b3f2397ac4d660409ed4874e16ba 100644
--- a/core/src/mindustry/net/Net.java
+++ b/core/src/mindustry/net/Net.java
@@ -10,6 +10,7 @@ import mindustry.game.EventType.*;
 import mindustry.gen.*;
 import mindustry.net.Packets.*;
 import mindustry.net.Streamable.*;
+import mindustryX.events.*;
 import net.jpountz.lz4.*;
 
 import java.io.*;
@@ -226,8 +227,10 @@ public class Net{
 
     /** Send an object to all connected clients, or to the server if this is a client.*/
     public void send(Object object, boolean reliable){
+        if(SendPacketEvent.emit(null, null, object)) return;
         if(server){
             for(NetConnection con : provider.getConnections()){
+                if(!con.hasBegunConnecting) continue;
                 con.send(object, reliable);
             }
         }else{
@@ -237,8 +240,9 @@ public class Net{
 
     /** Send an object to everyone EXCEPT a certain client. Server-side only.*/
     public void sendExcept(NetConnection except, Object object, boolean reliable){
+        if(SendPacketEvent.emit(null, except, object)) return;
         for(NetConnection con : getConnections()){
-            if(con != except){
+            if(con != except && con.hasBegunConnecting){
                 con.send(object, reliable);
             }
         }
